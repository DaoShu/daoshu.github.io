<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <style>
        body {
            padding: 0;
            margin: 0;
        }
        
        #myChart {
            display: block;
            position: fixed;
            width: 100%;
            height: 100%;
        }
    </style>
</head>

<body>
    <div id="myChart"></div>

    <script src="http://echarts.baidu.com/gallery/vendors/jquery/jquery.js"></script>
    <script src="http://echarts.baidu.com/gallery/vendors/bootstrap/js/bootstrap.js"></script>
    <script src="http://echarts.baidu.com/gallery/vendors/lodash.js"></script>
    <script src="http://echarts.baidu.com/gallery/vendors/dat.gui.min.js"></script>
    <script src="http://echarts.baidu.com/gallery/vendors/echarts/echarts-all-3.js"></script>
    <script src="http://echarts.baidu.com/gallery/vendors/echarts-stat/ecStat.min.js"></script>
    <script src="http://echarts.baidu.com/gallery/vendors/echarts/map/js/world.js"></script>
    <script src="http://echarts.baidu.com/gallery/vendors/echarts/extension/dataTool.js"></script>
    <script src="http://api.map.baidu.com/api?v=2.0&ak=53oVIOgmSIejwV7EfphPgTynOZbIiVYu"></script>
    <script src="http://echarts.baidu.com/gallery/vendors/echarts/extension/bmap.js"></script>
    <script src="index.js"></script>


    <script type="text/javascript">
        var myChart = echarts.init(document.getElementById('myChart'))
        var csvData = null;
        $.extend({
            csv: function(url, fn) {
                $.get(url, function(data) {
                    var result = [];
                    var json = {}
                    var index = 0;
                    var record = data.split(/\n/);
                    for (var i = 0, l = record.length; i < l; i++) {
                        var arr = record[i].split(',');
                        if (!json[arr[0]]) {
                            json[arr[0]] = {};
                            // 测试 start
                            json[arr[0]].coords = [
                                [arr[2], arr[3]]
                            ];
                            // 测试 end
                            json[arr[0]].index = index;
                            result[index] = {};
                            result[index].coords = [
                                [arr[2], arr[3]]
                            ];
                            index++;
                        } else {
                            json[arr[0]].coords.push([arr[2], arr[3]]);
                            result[json[arr[0]]['index']].coords.push([arr[2], arr[3]]);
                        }
                    }
                    console.log(json);
                    fn.call(this, result);
                    result = null;
                })
            },

            formatCoords: function(arr) {
                for (var i = 0, l = arr.length; i < l; i++) {
                    var coords = arr[i].coords;
                    var splitCoords = $._chunk(coords, 10);
                    for (var j = 0; j < splitCoords.length; j++) {
                        var params = '';
                        var wgs84togcj02;
                        var gcj02tobd09;
                        for (var k = 0, n = splitCoords[j].length; k < n; k++) {
                            // params += splitCoords[j][k].join(',') + ';'
                            wgs84togcj02 = coordtransform.wgs84togcj02(splitCoords[j][k][0], splitCoords[j][k][1]);
                            gcj02tobd09 = coordtransform.gcj02tobd09(wgs84togcj02[0], wgs84togcj02[1]);
                            splitCoords[j][k][0] = gcj02tobd09[0];
                            splitCoords[j][k][1] = gcj02tobd09[1];
                        }
                    }
                }
            },

            _chunk: function(array, size) {
                var result = [];
                for (var x = 0; x < Math.ceil(array.length / size); x++) {
                    var start = x * size;
                    var end = start + size;
                    result.push(array.slice(start, end));
                }
                return result;
            }
        }, )



        $.csv('carData.1.txt', function(data) {
            csvData = data;
            $.formatCoords(csvData)
                // console.log(csvData)
            myChart.setOption(option = {
                bmap: {
                    center: [116.41, 39.92],
                    zoom: 13,
                    roam: true,
                    mapStyle: {
                        'styleJson': [{
                            'featureType': 'water',
                            'elementType': 'all',
                            'stylers': {
                                'color': '#031628'
                            }
                        }, {
                            'featureType': 'land',
                            'elementType': 'geometry',
                            'stylers': {
                                'color': '#000102'
                            }
                        }, {
                            'featureType': 'highway',
                            'elementType': 'all',
                            'stylers': {
                                'visibility': 'off'
                            }
                        }, {
                            'featureType': 'arterial',
                            'elementType': 'geometry.fill',
                            'stylers': {
                                'color': '#000000'
                            }
                        }, {
                            'featureType': 'arterial',
                            'elementType': 'geometry.stroke',
                            'stylers': {
                                'color': '#0b3d51'
                            }
                        }, {
                            'featureType': 'local',
                            'elementType': 'geometry',
                            'stylers': {
                                'color': '#000000'
                            }
                        }, {
                            'featureType': 'railway',
                            'elementType': 'geometry.fill',
                            'stylers': {
                                'color': '#000000'
                            }
                        }, {
                            'featureType': 'railway',
                            'elementType': 'geometry.stroke',
                            'stylers': {
                                'color': '#08304b'
                            }
                        }, {
                            'featureType': 'subway',
                            'elementType': 'all',
                            'stylers': {
                                'visibility': 'off'
                            }
                        }, {
                            'featureType': 'building',
                            'elementType': 'geometry.fill',
                            'stylers': {
                                'color': '#000000'
                            }
                        }, {
                            'featureType': 'all',
                            'elementType': 'labels.text.fill',
                            'stylers': {
                                'color': '#857f7f'
                            }
                        }, {
                            'featureType': 'all',
                            'elementType': 'labels.text.stroke',
                            'stylers': {
                                'color': '#000000'
                            }
                        }, {
                            'featureType': 'building',
                            'elementType': 'geometry',
                            'stylers': {
                                'color': '#022338'
                            }
                        }, {
                            'featureType': 'green',
                            'elementType': 'geometry',
                            'stylers': {
                                'color': '#062032'
                            }
                        }, {
                            'featureType': 'boundary',
                            'elementType': 'all',
                            'stylers': {
                                'color': '#465b6c'
                            }
                        }, {
                            'featureType': 'manmade',
                            'elementType': 'all',
                            'stylers': {
                                'color': '#022338'
                            }
                        }, {
                            'featureType': 'label',
                            'elementType': 'all',
                            'stylers': {
                                'visibility': 'off'
                            }
                        }, {
                            "featureType": "local",
                            "elementType": "geometry.stroke",
                            "stylers": {
                                "color": "#ff0000"
                            }
                        }, {
                            "featureType": "arterial",
                            "elementType": "geometry.stroke",
                            "stylers": {
                                "color": "#ff0000"
                            }
                        }, {
                            "featureType": "highway",
                            "elementType": "geometry.fill",
                            "stylers": {
                                "color": "#ff0000"
                            }
                        } ]
                    }
                },
                series: [{
                    type: 'lines',
                    coordinateSystem: 'bmap',
                    polyline: true,
                    data: csvData,
                    silent: true,
                    lineStyle: {
                        normal: {
                            color: '#07bb07',
                            opacity: .1,
                            width: 1
                        }
                    },
                    progressiveThreshold: 500,
                    progressive: 200
                }]
            });
        })
    </script>
</body>

</html>